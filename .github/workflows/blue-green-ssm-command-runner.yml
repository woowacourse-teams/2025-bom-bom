name: Backend Blue-Green Production Deploy (SSM)

on:
  push:
    branches:
      - server-new
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-northeast-2
  ROLE_ARN: arn:aws:iam::715432481104:role/github_allow

  PROD1_ID: i-043b2198bd0564f99
  PROD2_ID: i-02583d84fc5e0c678
  LB_TARGET: i-06856239dadc6d1fa

  COMPOSE_FILE: docker-compose-prod-sub.yml
  HEALTH_URL: http://localhost:8081/actuator/health

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.mk.outputs.release_id }}
    steps:
      - id: mk
        run: echo "release_id=$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA::12}" >> $GITHUB_OUTPUT

  build:
    runs-on: ubuntu-latest
    needs: prepare
    defaults:
      run:
        working-directory: ./backend/bom-bom-server
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: temurin
          cache: gradle

      - name: Create application.yml
        run: |
          mkdir -p src/main/resources
          printf '%s' "${{ secrets.APPLICATION_PROD_PROPERTIES }}" > src/main/resources/application.yml

      - name: Build JAR
        run: ./gradlew clean assemble --no-daemon --stacktrace --info

      - uses: actions/upload-artifact@v4
        with:
          name: bom-bom-jar
          path: ./backend/bom-bom-server/build/libs/*.jar

  docker-image:
    runs-on: ubuntu-latest
    needs: build
    defaults:
      run:
        working-directory: ./backend/bom-bom-server
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: bom-bom-jar
          path: ./backend/bom-bom-server/build/libs

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push Image
        run: |
          docker buildx build \
            --platform linux/arm64,linux/amd64 \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/bom-bom:prod \
            --push .

  # -----------------------------------------------------------
  # üöÄ Step 1: Deploy PROD2 (Blue)
  # -----------------------------------------------------------
  deploy-prod2:
    name: "üöÄ Step 1: Deploy Prod2 (Blue)"
    needs: docker-image
    runs-on: ubuntu-latest
  
    steps:
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Debug SSM Instances
        run: |
          echo "===== AWS CALLER IDENTITY ====="
          aws sts get-caller-identity --region ${{ env.AWS_REGION }}
          echo "===== SSM MANAGED INSTANCES ====="
          aws ssm describe-instance-information --region ${{ env.AWS_REGION }}

      - name: Deploy via SSM
        run: |
          aws ssm send-command \
            --region ${{ env.AWS_REGION }} \
            --document-name "AWS-RunShellScript" \
            --targets "Key=instanceids,Values=${{ env.PROD2_ID }}" \
            --parameters commands='[
              "cd /opt/bom-bom",
              "sudo docker compose -f ${{ env.COMPOSE_FILE }} down || true",
              "sudo docker compose -f ${{ env.COMPOSE_FILE }} pull",
              "sudo docker compose -f ${{ env.COMPOSE_FILE }} up -d --remove-orphans --force-recreate"
            ]' \
            --comment "Deploy prod2"

  # -----------------------------------------------------------
  # ü©∫ Step 2: PROD2 Health Check
  # -----------------------------------------------------------
  healthcheck-prod2:
    name: "ü©∫ Step 2: Health Check Prod2"
    needs: deploy-prod2
    runs-on: ubuntu-latest
    steps:
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Health Check
        run: |
          for i in {1..30}; do
            CMD=$(aws ssm send-command \
              --region ${{ env.AWS_REGION }} \
              --document-name "AWS-RunShellScript" \
              --targets "Key=instanceids,Values=${{ env.PROD2_ID }}" \
              --parameters commands='["curl -o /dev/null -s -w \"%{http_code}\" '${{ env.HEALTH_URL }}'"]' \
              --query "Command.CommandId" \
              --output text)

            sleep 3

            RES=$(aws ssm get-command-invocation \
              --region ${{ env.AWS_REGION }} \
              --command-id "$CMD" \
              --instance-id "${{ env.PROD2_ID }}" \
              --query "StandardOutputContent" \
              --output text || echo "000")

            echo "STATUS: $RES"

            if [ "$RES" = "200" ]; then exit 0; fi
            sleep 5
          done

          exit 1

  # -----------------------------------------------------------
  # üîÄ Step 3: Switch traffic to PROD2
  # -----------------------------------------------------------
  shift-prod2-live:
    name: "üîÄ Step 3: Switch traffic to prod2"
    needs: healthcheck-prod2
    runs-on: ubuntu-latest
    steps:
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Switch HAProxy
        run: |
          aws ssm send-command \
            --region ${{ env.AWS_REGION }} \
            --document-name "AWS-RunShellScript" \
            --targets "Key=instanceids,Values=${{ env.LB_TARGET }}" \
            --parameters commands='[
              "echo \"disable server app_servers/prod1\" | sudo socat stdio /var/run/haproxy.sock",
              "echo \"enable server app_servers/prod2\" | sudo socat stdio /var/run/haproxy.sock"
            ]'

  # -----------------------------------------------------------
  # üöÄ Step 4: Deploy PROD1 (Green)
  # -----------------------------------------------------------
  deploy-prod1:
    name: "üöÄ Step 4: Deploy Prod1 (Green)"
    needs: shift-prod2-live
    runs-on: ubuntu-latest
    steps:
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy via SSM
        run: |
          aws ssm send-command \
            --region ${{ env.AWS_REGION }} \
            --document-name "AWS-RunShellScript" \
            --targets "Key=instanceids,Values=${{ env.PROD1_ID }}" \
            --parameters commands='[
              "cd /opt/bom-bom",
              "sudo docker compose -f ${{ env.COMPOSE_FILE }} down || true",
              "sudo docker compose -f ${{ env.COMPOSE_FILE }} pull",
              "sudo docker compose -f ${{ env.COMPOSE_FILE }} up -d --remove-orphans --force-recreate"
            ]'

  # -----------------------------------------------------------
  # ü©∫ Step 5: Health Check PROD1
  # -----------------------------------------------------------
  healthcheck-prod1:
    name: "ü©∫ Step 5: Health Check Prod1"
    needs: deploy-prod1
    runs-on: ubuntu-latest
    steps:
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Health Check
        run: |
          for i in {1..30}; do
            CMD=$(aws ssm send-command \
              --region ${{ env.AWS_REGION }} \
              --document-name "AWS-RunShellScript" \
              --targets "Key=instanceids,Values=${{ env.PROD1_ID }}" \
              --parameters commands='["curl -o /dev/null -s -w \"%{http_code}\" '${{ env.HEALTH_URL }}'"]' \
              --query "Command.CommandId" \
              --output text)

            sleep 3

            RES=$(aws ssm get-command-invocation \
              --region ${{ env.AWS_REGION }} \
              --command-id "$CMD" \
              --instance-id "${{ env.PROD1_ID }}" \
              --query "StandardOutputContent" \
              --output text || echo "000")

            if [ "$RES" = "200" ]; then exit 0; fi
            sleep 5
          done

          exit 1

  # -----------------------------------------------------------
  # üîÅ Step 6: Restore traffic (prod1 + prod2 enable)
  # -----------------------------------------------------------
  switch-final:
    name: "üîÅ Step 6: Restore traffic (prod1 + prod2)"
    needs: healthcheck-prod1
    runs-on: ubuntu-latest
    steps:
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Restore HAProxy
        run: |
          aws ssm send-command \
            --region ${{ env.AWS_REGION }} \
            --document-name "AWS-RunShellScript" \
            --targets "Key=instanceids,Values=${{ env.LB_TARGET }}" \
            --parameters commands='[
              "echo \"enable server app_servers/prod1\" | sudo socat stdio /var/run/haproxy.sock",
              "echo \"enable server app_servers/prod2\" | sudo socat stdio /var/run/haproxy.sock"
            ]'

name: Notify Discord (PR-OPEN)

on:
  pull_request:
    types: [opened, reopened, ready_for_review, labeled]

jobs:
  notify-reviewers:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    permissions:
      pull-requests: write
      contents: read

    steps:
      - uses: actions/checkout@v3

      # PR ì‘ì„±ìë¥¼ Assigneeë¡œ ìë™ ì„¤ì •
      - name: Auto Assign PR Author
        uses: actions/github-script@v8
        with:
          script: |
            const pr = context.payload.pull_request;
            const author = pr.user.login;

            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              assignees: [author]
            });

            console.log(`Assigned ${author} as PR assignee`);

      # notify_ids.json ê¸°ë°˜ìœ¼ë¡œ reviewer = 3ëª…, author ì œì™¸ í›„ ë©˜ì…˜
      - name: Load Reviewers from JSON
        id: get-reviewers
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const mapping = JSON.parse(fs.readFileSync('.github/notify_ids.json', 'utf8'));
            const members = Object.keys(mapping);

            const author = context.payload.pull_request.user.login;
            const filtered = members.filter(member => member !== author);

            const mentions = filtered
              .map(login => `<@${mapping[login]}>`)
              .join(' ');

            console.log(`Mentions: ${mentions}`);
            core.setOutput("discord_mentions", mentions);

      - name: Extract D-Tag
        id: extract
        uses: actions/github-script@v8
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(l => l.name);

            // ì •ê·œì‹ìœ¼ë¡œ D-ìˆ«ì ë¼ë²¨ë§Œ ì°¾ê¸°
            const dLabel = labels.find(l => /^D-\d+$/.test(l)) || "";

            core.setOutput("dlabel", dLabel);

      - name: Send PR Open Notification
        uses: ./.github/actions/discord-notification
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_PR }}
          content: "ğŸš€ ìƒˆ PRì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ë¦¬ë·° ë¶€íƒë“œë¦½ë‹ˆë‹¤ ğŸ™"
          mentions: ${{ steps.get-reviewers.outputs.discord_mentions }}
          title: "${{ steps.extract.outputs.dlabel }} | ${{ github.event.pull_request.title }}"
          url: ${{ github.event.pull_request.html_url }}
          color: 16753920
          fields: |
            [
              { "name": "ì‘ì„±ì", "value": "${{ github.event.pull_request.user.login }}" },
              { "name": "D-Day", "value": "${{ steps.extract.outputs.dlabel }}" }
            ]

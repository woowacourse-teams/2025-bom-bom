name: Pull Request Notifications

on:
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]

jobs:
  notify_assignee_on_approval:
    runs-on: ubuntu-latest
    if: github.event.review.state == 'approved'
    steps:
      - uses: actions/checkout@v3

      - name: Get Assignees List
        id: assignees
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const workers = JSON.parse(fs.readFileSync('.github/reviewers.json')); 
            const assignees = context.payload.pull_request.assignees || [];
            const mention = assignees.map((user) => {
              const login = user.login;
              const mappedValue = workers[login];
              return mappedValue ? `<@${mappedValue}>` : `No mapping found for ${login}`;
            })
            const assigneeText = mention.length > 0 ? `ğŸ“‹ ë‹´ë‹¹ì: ${mention.join(', ')}` : '';
            return assigneeText;
          result-encoding: string

      - name: Get PR Author
        id: author
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const workers = JSON.parse(fs.readFileSync('.github/reviewers.json')); 
            const author = context.payload.pull_request.user.login;
            const mappedValue = workers[author];
            return mappedValue ? `<@${mappedValue}>` : `No mapping found for ${author}`;
          result-encoding: string

      - name: Get Reviewer
        id: reviewer
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const workers = JSON.parse(fs.readFileSync('.github/reviewers.json')); 
            const reviewer = context.payload.review.user.login;
            const mappedValue = workers[reviewer];
            return mappedValue ? `<@${mappedValue}>` : `No mapping found for ${reviewer}`;
          result-encoding: string

      - name: Send approval notification to assignees
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: ${{ secrets.TEST_CHANNEL }}
          payload: |
            {
              "text": "PR approved notification",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ğŸ‰ *PRì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!*\n\n â€¢ ì œëª©: ${{ github.event.pull_request.title }}\n â€¢ ì‘ì„±ì: ${{ steps.author.outputs.result }}\n â€¢ ìŠ¹ì¸ì: ${{ steps.reviewer.outputs.result }}\n â€¢ ë§í¬: <${{ github.event.pull_request.html_url }}|PR ë³´ëŸ¬ ê°€ê¸°>\n\n${{ steps.assignees.outputs.result }}\n\nâœ… ìŠ¹ì¸ëœ PRì€ ê³§ ë¨¸ì§€ë  ì˜ˆì •ì…ë‹ˆë‹¤. ì¶”ê°€ ì‘ì—…ì´ í•„ìš”í•˜ë‹¤ë©´ ë¹ ë¥´ê²Œ ì§„í–‰í•´ì£¼ì„¸ìš”!"
                  }
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.TEST_BOT_TOKEN }}

  notify_on_comment:
    runs-on: ubuntu-latest
    if: github.event_name == 'issue_comment' && github.event.issue.pull_request
    steps:
      - uses: actions/checkout@v3

      - name: Get Comment Author
        id: comment_author
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const workers = JSON.parse(fs.readFileSync('.github/reviewers.json')); 
            const author = context.payload.comment.user.login;
            const mappedValue = workers[author];
            return mappedValue ? `<@${mappedValue}>` : `No mapping found for ${author}`;
          result-encoding: string

      - name: Get PR Assignees for Comment
        id: comment_assignees
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const workers = JSON.parse(fs.readFileSync('.github/reviewers.json')); 
            const assignees = context.payload.issue.assignees || [];
            const mention = assignees.map((user) => {
              const login = user.login;
              const mappedValue = workers[login];
              return mappedValue ? `<@${mappedValue}>` : `No mapping found for ${login}`;
            })
            const assigneeText = mention.length > 0 ? `ğŸ“‹ ë‹´ë‹¹ì: ${mention.join(', ')}` : '';
            return assigneeText;
          result-encoding: string

      - name: Get PR Author for Comment
        id: comment_pr_author
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const workers = JSON.parse(fs.readFileSync('.github/reviewers.json')); 
            const author = context.payload.issue.user.login;
            const mappedValue = workers[author];
            return mappedValue ? `<@${mappedValue}>` : `No mapping found for ${author}`;
          result-encoding: string

      - name: Send comment notification
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: ${{ secrets.TEST_CHANNEL }}
          payload: |
            {
              "text": "PR comment notification",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ğŸ’¬ *PRì— ëŒ“ê¸€ì´ ë‹¬ë ¸ìŠµë‹ˆë‹¤!*\n\n â€¢ ì œëª©: ${{ github.event.issue.title }}\n â€¢ ì‘ì„±ì: ${{ steps.comment_pr_author.outputs.result }}\n â€¢ ëŒ“ê¸€ ì‘ì„±ì: ${{ steps.comment_author.outputs.result }}\n â€¢ ë§í¬: <${{ github.event.issue.html_url }}|PR ë³´ëŸ¬ ê°€ê¸°>\n\n${{ steps.comment_assignees.outputs.result }}\n\nğŸ’­ ëŒ“ê¸€ ë‚´ìš©ì„ í™•ì¸í•˜ê³  í•„ìš”í•œ ì¡°ì¹˜ë¥¼ ì·¨í•´ì£¼ì„¸ìš”!"
                  }
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.TEST_BOT_TOKEN }}

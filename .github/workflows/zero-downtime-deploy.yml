name: Backend Blue-Green CI/CD

on:
  push:
    branches:
      - server-blue-green
  workflow_dispatch:

env:
  WORKING_BRANCH: server-blue-green
  HEALTH_CHECK_URL: http://localhost:8081/actuator/health

jobs:
  # ---------------------------------------------------
  # 1ï¸âƒ£ Build & Test & Push
  # ---------------------------------------------------
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend/bom-bom-server

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          ref: ${{ env.WORKING_BRANCH }}

      - name: JDK 21 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: temurin
          cache: gradle

      - name: application.yml ìƒì„± (Prod í™˜ê²½)
        run: |
          mkdir -p src/main/resources
          printf '%s' "${{ secrets.APPLICATION_PROD_PROPERTIES }}" > src/main/resources/application.yml

      - name: Gradle ë¹Œë“œ
        run: ./gradlew clean assemble --no-daemon --stacktrace --info

      - name: JAR ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: bom-bom-jar
          path: ./backend/bom-bom-server/build/libs/*.jar
          if-no-files-found: error

  test:
    runs-on: ubuntu-latest
    needs: build
    defaults:
      run:
        working-directory: ./backend/bom-bom-server

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          ref: ${{ env.WORKING_BRANCH }}

      - name: JDK 21 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: temurin
          cache: gradle

      - name: application.yml ìƒì„± (Test)
        run: |
          mkdir -p src/test/resources
          printf '%s' "${{ secrets.APPLICATION_TEST_PROPERTIES }}" > src/test/resources/application.yml

      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        env:
          SPRING_PROFILES_ACTIVE: test
          APPLE_P8_ESCAPED: ${{ secrets.APPLE_P8_ESCAPED }}
        run: |
          export OAUTH2_APPLE_PRIVATE_KEY="$(printf '%b' "$APPLE_P8_ESCAPED")"
          ./gradlew test --no-daemon --stacktrace --info

  docker-image:
    runs-on: ubuntu-latest
    needs: [build, test]
    defaults:
      run:
        working-directory: ./backend/bom-bom-server
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          ref: ${{ env.WORKING_BRANCH }}

      - name: JAR ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: bom-bom-jar
          path: ./backend/bom-bom-server/build/libs

      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3

      - name: DockerHub ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        run: |
          docker buildx build \
            --platform linux/arm64,linux/amd64 \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/bom-bom:prod \
            --push .
          echo "âœ… Docker ì´ë¯¸ì§€ í‘¸ì‹œ ì™„ë£Œ"

  # ---------------------------------------------------
  # 2ï¸âƒ£ prod-sub ë°°í¬ ì¤€ë¹„ (íŠ¸ë˜í”½ ì „í™˜)
  # ---------------------------------------------------
  shift-traffic-to-main:
    name: "ğŸ”€ Step 1: íŠ¸ë˜í”½ì„ prod-mainìœ¼ë¡œ ì´ë™"
    needs: docker-image
    runs-on: [self-hosted, lb]
    steps:
      - name: prod-sub â†’ prod-main íŠ¸ë˜í”½ ì´ë™
        run: |
          echo "ğŸ”„ prod-sub ì„œë²„ ë¹„í™œì„±í™”"
          echo "disable server app_servers/prod-sub" | sudo socat stdio /var/run/haproxy.sock
          echo "âœ… ëª¨ë“  íŠ¸ë˜í”½ì´ prod-mainìœ¼ë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤."

  # ---------------------------------------------------
  # 3ï¸âƒ£ prod-sub ë°°í¬
  # ---------------------------------------------------
  deploy-sub:
    name: "ğŸš€ Step 2: prod-sub ë°°í¬"
    needs: shift-traffic-to-main
    runs-on: [self-hosted, prod-sub]
    defaults:
      run:
        working-directory: ./backend/bom-bom-server

    steps:
      - name: DockerHub ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: .env íŒŒì¼ ìƒì„± ë° ë°±ì—…
        run: |
          echo "ğŸ“¦ .env íŒŒì¼ ìƒì„± ì‹œì‘"
          if [ -f .env ]; then
            cp .env .env.backup
            echo "ğŸ“¦ ê¸°ì¡´ .env ë°±ì—… ì™„ë£Œ"
          fi

          cat <<EOF > .env
          RDS_ENDPOINT=${{ secrets.PROD_RDS_ENDPOINT }}
          DATABASE=${{ secrets.PROD_DATABASE }}
          MYSQL_USER=${{ secrets.PROD_MYSQL_USER }}
          MYSQL_PASSWORD=${{ secrets.PROD_MYSQL_PASSWORD }}
          SPRING_PROFILES_ACTIVE=prod
          PROD_OTEL_ENDPOINT=${{ secrets.PROD_OTEL_ENDPOINT }}
          EOF

          for var in RDS_ENDPOINT DATABASE MYSQL_USER MYSQL_PASSWORD; do
            if ! grep -q "^${var}=" .env || grep -q "^${var}=$" .env; then
              echo "âŒ ${var} ëˆ„ë½ ë˜ëŠ” ë¹„ì–´ìˆìŒ"
              exit 1
            fi
          done
          echo "âœ… .env íŒŒì¼ ìƒì„± ë° ê²€ì¦ ì™„ë£Œ"

      - name: ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
        run: |
          if sudo docker ps --format "{{.Names}}" | grep -q "bombom-server"; then
            echo "ğŸ›‘ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ"
            sudo docker stop bombom-server || true
            sudo docker rm bombom-server || true
          fi

      - name: ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
        env:
          APPLE_P8_ESCAPED: ${{ secrets.APPLE_P8_ESCAPED }}
        run: |
          export OAUTH2_APPLE_PRIVATE_KEY="$(printf '%b' "$APPLE_P8_ESCAPED")"
          echo "ğŸš€ ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘..."
          sudo --preserve-env=OAUTH2_APPLE_PRIVATE_KEY docker compose -f docker-compose-prod.yml --env-file .env up -d --pull=always --force-recreate
          echo "âœ… ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ ì™„ë£Œ"

      - name: ì»¨í…Œì´ë„ˆ í—¬ìŠ¤ì²´í¬
        run: |
          echo "ğŸ¥ ì»¨í…Œì´ë„ˆ í—¬ìŠ¤ì²´í¬ ì‹œì‘..."
          for i in {1..20}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.HEALTH_CHECK_URL }} || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "âœ… Healthy"
              exit 0
            fi
            echo "â³ ìƒíƒœ: $STATUS ($i/20)"
            sleep 10
          done
          echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
          sudo docker logs bombom-server --tail 50 || true
          exit 1

  # ---------------------------------------------------
  # 4ï¸âƒ£ íŠ¸ë˜í”½ ì „í™˜: prod-main â†’ prod-sub
  # ---------------------------------------------------
  shift-traffic-to-sub:
    name: "ğŸ”€ Step 3: íŠ¸ë˜í”½ì„ prod-subë¡œ ì „í™˜"
    needs: deploy-sub
    runs-on: [self-hosted, lb]
    steps:
      - name: prod-main â†’ prod-sub íŠ¸ë˜í”½ ì´ë™
        run: |
          echo "ğŸ”„ prod-main ë¹„í™œì„±í™”"
          echo "disable server app_servers/prod-main" | sudo socat stdio /var/run/haproxy.sock
          echo "ğŸ”„ prod-sub í™œì„±í™”"
          echo "enable server app_servers/prod-sub" | sudo socat stdio /var/run/haproxy.sock
          echo "âœ… íŠ¸ë˜í”½ì´ prod-subë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤."

  # ---------------------------------------------------
  # 5ï¸âƒ£ prod-main ë°°í¬
  # ---------------------------------------------------
  deploy-main:
    name: "ğŸš€ Step 4: prod-main ë°°í¬"
    needs: shift-traffic-to-sub
    runs-on: [self-hosted, prod-main]
    defaults:
      run:
        working-directory: ./backend/bom-bom-server

    steps:
      - name: DockerHub ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: .env íŒŒì¼ ìƒì„± ë° ë°±ì—…
        run: |
          echo "ğŸ“¦ .env íŒŒì¼ ìƒì„± ì‹œì‘"
          if [ -f .env ]; then
            cp .env .env.backup
            echo "ğŸ“¦ ê¸°ì¡´ .env ë°±ì—… ì™„ë£Œ"
          fi

          cat <<EOF > .env
          RDS_ENDPOINT=${{ secrets.PROD_RDS_ENDPOINT }}
          DATABASE=${{ secrets.PROD_DATABASE }}
          MYSQL_USER=${{ secrets.PROD_MYSQL_USER }}
          MYSQL_PASSWORD=${{ secrets.PROD_MYSQL_PASSWORD }}
          SPRING_PROFILES_ACTIVE=prod
          PROD_OTEL_ENDPOINT=${{ secrets.PROD_OTEL_ENDPOINT }}
          EOF

          for var in RDS_ENDPOINT DATABASE MYSQL_USER MYSQL_PASSWORD; do
            if ! grep -q "^${var}=" .env || grep -q "^${var}=$" .env; then
              echo "âŒ ${var} ëˆ„ë½ ë˜ëŠ” ë¹„ì–´ìˆìŒ"
              exit 1
            fi
          done
          echo "âœ… .env íŒŒì¼ ìƒì„± ë° ê²€ì¦ ì™„ë£Œ"

      - name: ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
        run: |
          if sudo docker ps --format "{{.Names}}" | grep -q "bombom-server"; then
            echo "ğŸ›‘ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ"
            sudo docker stop bombom-server || true
            sudo docker rm bombom-server || true
          fi

      - name: ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
        env:
          APPLE_P8_ESCAPED: ${{ secrets.APPLE_P8_ESCAPED }}
        run: |
          export OAUTH2_APPLE_PRIVATE_KEY="$(printf '%b' "$APPLE_P8_ESCAPED")"
          sudo --preserve-env=OAUTH2_APPLE_PRIVATE_KEY docker compose -f docker-compose-prod.yml --env-file .env up -d --pull=always --force-recreate
          echo "âœ… ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì™„ë£Œ"

      - name: ì»¨í…Œì´ë„ˆ í—¬ìŠ¤ì²´í¬
        run: |
          echo "ğŸ¥ ì»¨í…Œì´ë„ˆ í—¬ìŠ¤ì²´í¬ ì‹œì‘..."
          for i in {1..20}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.HEALTH_CHECK_URL }} || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "âœ… Healthy"
              exit 0
            fi
            echo "â³ ìƒíƒœ: $STATUS ($i/20)"
            sleep 10
          done
          echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
          sudo docker logs bombom-server --tail 50 || true
          exit 1

  # ---------------------------------------------------
  # 6ï¸âƒ£ íŠ¸ë˜í”½ ë³µê·€
  # ---------------------------------------------------
  restore-final-traffic:
    name: "ğŸ” Step 5: íŠ¸ë˜í”½ ì›ìƒë³µê·€"
    needs: deploy-main
    runs-on: [self-hosted, lb]
    steps:
      - name: HAProxy íŠ¸ë˜í”½ ë¹„ìœ¨ ë³µê·€
        run: |
          echo "ğŸ”„ prod-main ì¬í™œì„±í™”"
          echo "enable server app_servers/prod-main" | sudo socat stdio /var/run/haproxy.sock
          echo "âœ… ë°°í¬ ì™„ë£Œ ë° íŠ¸ë˜í”½ ì •ìƒí™”"
